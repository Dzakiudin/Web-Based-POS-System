// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================
// ENUMS
// ============================================================

enum Role {
  OWNER
  ADMIN
  CASHIER
}

enum PaymentMethod {
  CASH
  QRIS
  CARD
  EWALLET
}

enum SaleStatus {
  COMPLETED
  VOIDED
  REFUNDED
  HELD
}

enum DiscountType {
  PERCENTAGE
  FIXED
}

enum CashMovementType {
  CASH_IN
  CASH_OUT
}

enum StockMovementType {
  IN
  OUT
  ADJUSTMENT
  SALE
  REFUND
}

enum MembershipTier {
  BRONZE
  SILVER
  GOLD
  PLATINUM
}

// ============================================================
// CORE MODELS
// ============================================================

model User {
  id        Int      @id @default(autoincrement())
  name      String
  username  String   @unique
  password  String
  pin       String?
  email     String?
  phone     String?
  role      Role     @default(CASHIER)
  isActive  Boolean  @default(true)
  tokens    Token[]
  sales     Sale[]
  cashSessions CashSession[]
  auditLogs AuditLog[]
  stockMovements StockMovement[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("users")
}

model Token {
  id        Int      @id @default(autoincrement())
  token     String   @unique
  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@map("tokens")
}

// ============================================================
// PRODUCT & INVENTORY
// ============================================================

model Category {
  id          Int       @id @default(autoincrement())
  name        String    @unique
  description String?
  color       String    @default("#6366f1")
  icon        String    @default("Package")
  products    Product[]
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@map("categories")
}

model Product {
  id          Int              @id @default(autoincrement())
  name        String
  sku         String?          @unique
  barcode     String?          @unique
  price       Decimal          @db.Decimal(12, 2)
  costPrice   Decimal          @default(0) @db.Decimal(12, 2)
  stock       Int
  minStock    Int              @default(5)
  image       String?
  categoryId  Int?
  category    Category?        @relation(fields: [categoryId], references: [id])
  isActive    Boolean          @default(true)
  variants    ProductVariant[]
  saleDetails SaleDetail[]
  stockMovements StockMovement[]
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  @@map("products")
}

model ProductVariant {
  id          Int          @id @default(autoincrement())
  productId   Int
  product     Product      @relation(fields: [productId], references: [id], onDelete: Cascade)
  name        String       // e.g. "Large", "Red", "Extra Cheese"
  sku         String?      @unique
  price       Decimal      @db.Decimal(12, 2)
  costPrice   Decimal      @default(0) @db.Decimal(12, 2)
  stock       Int          @default(0)
  isActive    Boolean      @default(true)
  saleDetails SaleDetail[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@map("product_variants")
}

model StockMovement {
  id        Int               @id @default(autoincrement())
  productId Int
  product   Product           @relation(fields: [productId], references: [id])
  type      StockMovementType
  quantity  Int
  reason    String?
  reference String?           // e.g. "Sale #123" or "PO-001"
  userId    Int?
  user      User?             @relation(fields: [userId], references: [id])
  createdAt DateTime          @default(now())

  @@map("stock_movements")
}

// ============================================================
// CUSTOMER & CRM
// ============================================================

model Customer {
  id             Int            @id @default(autoincrement())
  name           String
  email          String?
  address        String?
  phone          String?
  loyaltyPoints  Int            @default(0)
  membershipTier MembershipTier @default(BRONZE)
  totalSpent     Decimal        @default(0) @db.Decimal(12, 2)
  sales          Sale[]
  vouchers       Voucher[]
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  @@map("customers")
}

model Voucher {
  id         Int      @id @default(autoincrement())
  code       String   @unique
  customerId Int?
  customer   Customer? @relation(fields: [customerId], references: [id])
  discountId Int?
  discount   Discount? @relation(fields: [discountId], references: [id])
  isUsed     Boolean  @default(false)
  usedAt     DateTime?
  expiresAt  DateTime
  createdAt  DateTime @default(now())

  @@map("vouchers")
}

// ============================================================
// SALES & PAYMENTS
// ============================================================

model Sale {
  id             Int          @id @default(autoincrement())
  receiptNumber  String       @unique @default(cuid())
  date           DateTime     @default(now())
  totalPrice     Decimal      @db.Decimal(12, 2)
  discountAmount Decimal      @default(0) @db.Decimal(12, 2)
  finalPrice     Decimal      @default(0) @db.Decimal(12, 2)
  status         SaleStatus   @default(COMPLETED)
  notes          String?
  customerId     Int?
  customer       Customer?    @relation(fields: [customerId], references: [id])
  userId         Int?
  user           User?        @relation(fields: [userId], references: [id])
  cashSessionId  Int?
  cashSession    CashSession? @relation(fields: [cashSessionId], references: [id])
  details        SaleDetail[]
  payments       Payment[]
  refundReason   String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@map("sales")
}

model SaleDetail {
  id              Int             @id @default(autoincrement())
  saleId          Int
  sale            Sale            @relation(fields: [saleId], references: [id], onDelete: Cascade)
  productId       Int
  product         Product         @relation(fields: [productId], references: [id])
  variantId       Int?
  variant         ProductVariant? @relation(fields: [variantId], references: [id])
  quantity        Int
  unitPrice       Decimal         @default(0) @db.Decimal(12, 2)
  discountAmount  Decimal         @default(0) @db.Decimal(12, 2)
  subtotal        Decimal         @db.Decimal(12, 2)

  @@map("sale_details")
}

model Payment {
  id        Int           @id @default(autoincrement())
  saleId    Int
  sale      Sale          @relation(fields: [saleId], references: [id], onDelete: Cascade)
  method    PaymentMethod
  amount    Decimal       @db.Decimal(12, 2)
  change    Decimal       @default(0) @db.Decimal(12, 2)
  reference String?       // e.g. QRIS ref number, card auth code
  createdAt DateTime      @default(now())

  @@map("payments")
}

// ============================================================
// DISCOUNTS & PROMOS
// ============================================================

model Discount {
  id          Int          @id @default(autoincrement())
  name        String
  type        DiscountType
  value       Decimal      @db.Decimal(12, 2)
  minPurchase Decimal      @default(0) @db.Decimal(12, 2)
  code        String?      @unique
  startDate   DateTime     @default(now())
  endDate     DateTime?
  isActive    Boolean      @default(true)
  maxUses     Int?
  usedCount   Int          @default(0)
  vouchers    Voucher[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@map("discounts")
}

// ============================================================
// CASH MANAGEMENT
// ============================================================

model CashSession {
  id              Int              @id @default(autoincrement())
  userId          Int
  user            User             @relation(fields: [userId], references: [id])
  openingBalance  Decimal          @db.Decimal(12, 2)
  closingBalance  Decimal?         @db.Decimal(12, 2)
  expectedBalance Decimal?         @db.Decimal(12, 2)
  difference      Decimal?         @db.Decimal(12, 2)
  status          String           @default("OPEN") // OPEN, CLOSED
  notes           String?
  sales           Sale[]
  movements       CashMovement[]
  openedAt        DateTime         @default(now())
  closedAt        DateTime?

  @@map("cash_sessions")
}

model CashMovement {
  id        Int              @id @default(autoincrement())
  sessionId Int
  session   CashSession      @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  type      CashMovementType
  amount    Decimal          @db.Decimal(12, 2)
  reason    String
  createdAt DateTime         @default(now())

  @@map("cash_movements")
}

// ============================================================
// AUDIT & LOGGING
// ============================================================

model AuditLog {
  id        Int      @id @default(autoincrement())
  userId    Int?
  user      User?    @relation(fields: [userId], references: [id])
  action    String   // e.g. "CREATE_SALE", "VOID_SALE", "UPDATE_PRODUCT"
  entity    String   // e.g. "Sale", "Product", "User"
  entityId  Int?
  details   String?  @db.Text // JSON string of change details
  ip        String?
  createdAt DateTime @default(now())

  @@map("audit_logs")
}
